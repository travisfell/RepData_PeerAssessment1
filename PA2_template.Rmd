---
title: 'Peer Assessment 2: Storm Data Analysis'
author: "Travis Fell"
date: "Monday, April 20, 2015"
output: html_document
---

##Synopsis
This analysis is meant to shed light on the consequences of severe atmospheric events for public health and economic activity.  

##Data Processing
This section describes how the data for this analysis was acquired and made usable. 

First, the environment needs to be prepped by loading needed packages, turning off scientific notation. Assuming the data has been downloaded to a folder one level below the working directory called PA2_data, read in the data. 

```{r cache=TRUE}
library(dplyr)
library(plyr)
library(ggplot2)
options(scipen=999)
data <- read.csv("./PA2_data/repdata-data-StormData.csv.bz2", as.is = TRUE, stringsAsFactors = FALSE)

```
Upon reading in the data, do some intial analysis on the state of the data.
```{r}
dim(data)
```
The data has 902,297 rows and 37 columns. 

Now, have a look at the first few lines records, column names and data types. 
```{r}
head(data)
str(data)
```

Both analysis in this assignement look at results from certain weather events. So we'll look more closely at the EVTYPE column. Specifically, we'll find the unique list of those events that have any public health and/or economic impact, and ensure those events match the standard event descriptions from NOAA. For this analysis, we'll assume that events with at least 1 fatality or one injury have a public health impact and events with greater than 0 property damage or greater than 0 crop damage have an economic impact.

```{r}
unique(data$PROPDMGEXP) #understand what is in this column
unique(data$CROPDMGEXP) #understand what is in this column

uniqueEvents <- unique(subset(data, FATALITIES >0|INJURIES > 0|PROPDMG > 0|CROPDMG > 0, select = "EVTYPE"))
#uniqueEvents[order(uniqueEvents$EVTYPE)]
print(uniqueEvents <- arrange(uniqueEvents, EVTYPE))

```
There are 488 unique weather events that have a public health and/or economic. However, upon closer examination of this list, it is apparent that many are near matches to each other or are non-standard entries, which probably resulted from data entry errors. So, for events that have any health or economic impact, we need to map each unique value to the actual value as documented in the "NATIONAL WEATHER SERVICE INSTRUCTION 10-1605" document (available at this link: https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf). 

To methodically work through and map all 488 unique events to a standard event, we'll use the following method
1. Match to the NOAA event list to eliminate those that already match. 
2. Iteratively work through the document using pattern matching and replacement commands to change groups of non-standard event names to standard event names. 
3. Use the equivalent of a left outer join unmatch query in SQL to identify the remaining non-standard event names to map to standard names until all 488 are mapped. 

```{r}
#create column that will be used to map non-std events to std events
uniqueEvents$noaaEvents <- uniqueEvents$EVTYPE 

# change NOAA colums to upper case to enable better matching: 
uniqueEvents$noaaEvents <- toupper(uniqueEvents$noaaEvents)

# use pattern matching to replace non-std events with std events
uniqueEvents$noaaEvents <- gsub(".*TSTM.*", "THUNDERSTORM WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^TORNADO.*", "TORNADO", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^THU.*ST.*M.*W.*", "THUNDERSTORM WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*FIRE.*", "WILDFIRE", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*FLASH.*FLOOD.*", "FLASH FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*FLOOD.*FLASH.*", "FLASH FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*COAST.*FLOOD.*", "COASTAL FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*HAIL.*", "HAIL", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^COLD.*", "COLD/WIND CHILL", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^SNOW.*", "HEAVY SNOW", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^HIGH WIND.*", "STRONG WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*SLIDE.*", "AVALANCHE", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*EX.*COLD", "EXTREME COLD/WIND CHILL", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*EX.*CHILL", "EXTREME COLD/WIND CHILL", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*SWELL.*", "HIGH SURF", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*HURRICANE.*", "HURRICANE (TYPHOON)", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*LI.*ING.*", "LIGHTNING", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^HEAVY SNOW.*", "HEAVY SNOW", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^H.*VY RAIN.*", "HEAVY RAIN", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^TROPICAL STORM.*", "TROPICAL STORM", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*H.*SURF.*", "HIGH SURF", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^FREEZING.*", "SLEET", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^WATERSPOUT.*", "WATERSPOUT", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^WIN.*MIX", "WINTER WEATHER", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^GUSTY.*WIND.*", "HIGH WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^GRADIENT.*WIND.*", "STRONG WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^COASTAL.*STORM", "STORM SURGE/TIDE", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("WHIRLWIND", "TORNADO", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^WINTER STORM.*", "WINTER STORM", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^WIND.*", "HIGH WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^URBAN.*", "FLASH FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^R.*FLOOD.*", "FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^TIDAL.*FLOOD.*", "COASTAL FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^FR.*[E|T]", "FROST/FREEZE", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*LAKE.*SNOW", "LAKE-EFFECT SNOW", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^L.*SNOW.*", "WINTER WEATHER", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^ICE [J|F].*", "DEBRIS FLOW", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^IC[E|Y].*", "ICE STORM", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^ST.*WINDS", "STRONG WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^SEVERE THUNDERSTORM.*", "THUNDERSTORM WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^MICROBURST.*", "THUNDERSTORM WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^HYP.*THERMIA.*", "EXTREME COLD/WIND CHILL", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^HEAT.*", "HEAT", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*HEAT$", "EXCESSIVE HEAT", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^GLAZE.*", "FREEZING FOG", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^MIXED.*", "WINTER WEATHER", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("AVALANCE", "AVALANCHE", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*FREEZE", "FROST/FREEZE", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("BLACK ICE", "ICE STORM", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("BLOWING SNOW", "BLIZZARD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*BLIZZARD.*", "BLIZZARD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("DROWNING", "FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*MI[CR][RC]OBURST.*", "THUNDERSTORM WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("EXCESSIVE RAINFALL", "HEAVY RAIN", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("EXCESSIVE SNOW", "HEAVY SNOW", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^FLOOD.*", "FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^T.*UNDER.*", "THUNDERSTORM WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*SURGE.*", "STORM SURGE/TIDE", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*TIDE.*", "STORM SURGE/TIDE", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*COLD$", "COLD/WIND CHILL", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*DUST.*", "DUST STORM", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^RAIN.*", "HEAVY RAIN", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*EROSION.*", "COASTAL FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".*RAINFALL.*", "HEAVY RAIN", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^FOG.*", "DENSE FOG", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub(".* SEAS$", "HIGH SURF", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("\\?", "OTHER", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("APACHE COUNTY", "OTHER", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("BREAKUP FLOODING", "FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("COOL AND WET", "COLD/WIND CHILL", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("DAM BREAK", "FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("DOWNBURST", "HEAVY RAIN", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("EARLY FROST", "FROST/FREEZE", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("EXCESSIVE WETNESS", "HEAVY RAIN", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("FALLING SNOW/ICE", "HEAVY SNOW", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("GUSTNADO", "TORNADO", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("HEAVY MIX", "WINTER WEATHER", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("HEAVY PRECIPITATION", "HEAVY RAIN", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("HEAVY SHOWER", "HEAVY RAIN", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^HIGH$", "STRONG WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("HIGH  WINDS", "STRONG WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("HIGH WATER", "FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("HIGH WAVES", "HIGH SURF", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("LAKE FLOOD", "LAKESHORE FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("LANDSLUMP", "AVALANCHE", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("LANDSPOUT", "TORNADO", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("LOW TEMPERATURE", "COLD/WIND CHILL", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("MAJOR FLOOD", "FLASH FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("MARINE ACCIDENT", "MARINE STRONG WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("MARINE MISHAP", "MARINE STRONG WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("MINOR FLOODING", "FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("NON-SEVERE WIND DAMAGE", "STRONG WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("OTHER", "OTHER", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("RAPIDLY RISING WATER", "FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("RECORD SNOW", "HEAVY SNOW", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("RIP CURRENTS", "RIP CURRENT", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("ROGUE WAVE", "RIP CURRENT", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("SEVERE TURBULENCE", "THUNDERSTORM WIND", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("SLEET/ICE STORM", "SLEET", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("SMALL STREAM FLOOD", "FLOOD", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("TORNDAO", "TORNADO", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("^TYPHOON", "HURRICANE (TYPHOON)", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("UNSEASONABLY WARM.*", "HEAT", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("UNSEASONAL RAIN", "HEAVY RAIN", uniqueEvents$noaaEvents)
uniqueEvents$noaaEvents <- gsub("WARM WEATHER", "HEAT", uniqueEvents$noaaEvents)

# find EVTYPES that do not currently match NOAA events
anti_join(uniqueEvents, noaaEvents, by = c("noaaEvents" = "NoaaEvent"))
```
The data frame uniqueEvents now maps the non-standard event names with any health or economic impact to  standard NOAA event names. Now we need to associate the standard event names with their corresponding records in the data table.
```{r}
# create blank column to populate with standard event names
data$noaaEvent <- ''



```


##Results
This section walks through the various analytical steps to address the two questions in this assignment: 
1. Across the United States, which types of events are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?

###Storm Impact on Public Health
This section examines the impact of severe weather events on public health.  

```{r}

```


To start digging into, we'll summarize the total fatalities and injuries by EVTYPE and give the resulting set meaningful column names. 

```{r}
#data$EVTYPE <- as.factor(data$EVTYPE)
health <- summarise(group_by(data, EVTYPE), sum(FATALITIES), sum(INJURIES))
colnames(health) <- c("EVTYPE", "FATALITIES", "INJURIES")
```
Now that the health data is in a summarized, human readable format, we will start examining it's parameters to get a feel for how to continue the analysis. We will identify the total number of fatalities/injuries, examine the top 10 events by number of fatalities and injuries. 
```{r}
head(arrange(health, desc(FATALITIES)), 10)
head(arrange(health, desc(INJURIES)), 10)
```
Now, we'll combine fatalities and injuries into a "total casualties" column then calculate each event's casualties as a percent of the whole and draw some conclusions about storm impacts on public health. 
```{r}
health <- mutate(health, CASUALTIES = FATALITIES + INJURIES)
totalCasualties <- sum(health$CASUALTIES)
health <- mutate(health, CASUALTYPERCENT = round(100 * CASUALTIES/totalCasualties, digits = 1))
print(topCasualtyEvents <- head(arrange(health, desc(CASUALTYPERCENT)), 10))
top10CombinedPercent <- sum(topCasualtyEvents$CASUALTYPERCENT)
```
Assuming that public health impact is measured by the combination of fatalities and injuries, the chart above shows that tornados are far and away the biggest threat to public health from severe weather. As the top 10 events account for `r top10CombinedPercent`% of weather-related casualties, public health and safety officials should develop contingency plans for all these events, though with emphasis on tornados.  




